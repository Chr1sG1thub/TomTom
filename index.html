<!DOCTYPE html>
<html>
<head>
<title>TomTom</title>
</head>

<body>
<table id="results">
  <thead>
    <tr>
      <th>Departure</th>
      <th>Travel time (min)</th>
      <th>Traffic delay (min)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>

const apiKey  = 'BWvoMYm4TNcjfN2isTdSaVgwewWb0pSz';
const origin  = '42.6403,2.5227';   // Home
const dest    = '42.7248,2.88736';   // CHP
function toLocalIsoNoSeconds(d) {
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}` +
         `T${pad(d.getHours())}:${pad(d.getMinutes())}:00`;
}

// Tomorrow, local time
const day = new Date();
day.setDate(day.getDate() + 1);
day.setSeconds(0, 0);

const start = new Date(day);
start.setHours(6, 0, 0, 0);

const end = new Date(day);
end.setHours(8, 0, 0, 0);

const tbody = document.querySelector('#results tbody');

async function runLoop() {
  for (let t = new Date(start); t < end; t.setMinutes(t.getMinutes() + 5)) {
    const departAt = toLocalIsoNoSeconds(t);
    const url = `https://api.tomtom.com/routing/1/calculateRoute/${origin}:${dest}/json` +
                `?travelMode=car&traffic=true&departAt=${encodeURIComponent(departAt)}&key=${apiKey}`;

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const route = data.routes && data.routes[0];
      if (!route) {
        console.warn('No route for', departAt, data);
        continue;
      }
      const s = route.summary; // lengthInMeters, travelTimeInSeconds, trafficDelayInSeconds [web:61][web:64]

      const travelMin = (s.travelTimeInSeconds / 60).toFixed(1);
      const delayMin  = (s.trafficDelayInSeconds / 60).toFixed(1);

      const tr  = document.createElement('tr');
      const td1 = document.createElement('td');
      const td2 = document.createElement('td');
      const td3 = document.createElement('td');

      td1.textContent = departAt;
      td2.textContent = travelMin;
      td3.textContent = delayMin;

      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tbody.appendChild(tr);
    } catch (e) {
      console.error('Error for', departAt, e);
    }
  }
}

runLoop();
            
</script>
  
</body>

</html>
